# Account Statement Download (E-Statement) - Backend Requirements

## Overview

This document specifies the backend requirements for generating and downloading account statements (e-statements) as PDF documents. The e-statement should include all transaction details with timestamps and creator information.

## API Endpoint

**Endpoint**: `GET /api/accounts/{id}/statement`

**Auth**: `auth:sanctum`, `module:module.accounting,read`

## Query Parameters

- `start_date` (optional, string, format: `YYYY-MM-DD`): Start date for filtering transactions
- `end_date` (optional, string, format: `YYYY-MM-DD`): End date for filtering transactions

If no date filters are provided, include all transactions for the account.

## Response

**Content-Type**: `application/pdf`

**Response**: PDF file (binary)

## E-Statement Content Requirements

### 1. Header Section

The PDF should include:

- **Company Information**:
  - Company name
  - Company address (if available)
  - Company logo (if available)
  
- **Account Information**:
  - Account name
  - Account number (if available)
  - Account type (Group or Ledger)
  - Root type (Asset, Liability, Equity, Income, Expense)
  - Normal balance (for ledger accounts)
  - Current balance
  
- **Statement Period**:
  - Start date (or "All Time" if no filter)
  - End date (or "Current Date" if no filter)
  - Generated date and time

### 2. Transaction Details

#### For Ledger Accounts

Display all transactions for the account with the following columns:

| Column | Description | Format |
|--------|-------------|--------|
| **Date** | Transaction date | DD/MM/YYYY or DD MMM YYYY |
| **Time** | Exact creation timestamp | HH:MM:SS AM/PM |
| **Voucher Type** | Type of voucher (Journal Entry, Payment, Receipt, etc.) | Text |
| **Reference Number** | Voucher reference number | Text (if available) |
| **Description** | Transaction description | Text (if available) |
| **Created By** | User who created the transaction | Full name |
| **Debit** | Debit amount | Currency format (PKR 1,000.00) |
| **Credit** | Credit amount | Currency format (PKR 1,000.00) |
| **Balance** | Running balance after this transaction | Currency format (PKR 1,000.00) |

**Sorting**: Transactions should be sorted by:
1. Date (ascending - oldest first)
2. Created timestamp (ascending)
3. ID (ascending)

#### For Group Accounts (Parent Accounts)

Display all transactions from all child accounts with the following columns:

| Column | Description | Format |
|--------|-------------|--------|
| **Date** | Transaction date | DD/MM/YYYY or DD MMM YYYY |
| **Time** | Exact creation timestamp | HH:MM:SS AM/PM |
| **Account** | Child account name and number | "Account Name (Number)" |
| **Voucher Type** | Type of voucher | Text |
| **Reference Number** | Voucher reference number | Text (if available) |
| **Description** | Transaction description | Text (if available) |
| **Created By** | User who created the transaction | Full name |
| **Debit** | Debit amount | Currency format |
| **Credit** | Credit amount | Currency format |
| **Balance** | Running balance of the specific child account | Currency format |
| **Group Balance** | Cumulative balance of all child accounts | Currency format |

**Sorting**: 
- Group by child account (optional, or show all mixed)
- Within each account, sort by date, then timestamp, then ID (ascending)

### 3. Summary Section

At the end of the statement, include:

- **Total Debit**: Sum of all debit amounts (excluding net-zero transactions)
- **Total Credit**: Sum of all credit amounts (excluding net-zero transactions)
- **Net Change**: Difference between total debit and total credit
- **Opening Balance**: Balance at the start of the period (if date filter applied)
- **Closing Balance**: Balance at the end of the period (current balance)

### 4. Footer Section

- Page numbers (if multiple pages)
- "Generated on: [Date] [Time]"
- "Generated by: [User Name]"
- Page numbers (e.g., "Page 1 of 5")

## Data Requirements

### Transaction Data

Each transaction must include:

```json
{
  "id": 1,
  "date": "2026-01-01",
  "voucher_type": "Journal Entry",
  "reference_number": "JV-001",
  "description": "Opening balance",
  "debit": 1000.00,
  "credit": 0.00,
  "balance": 1000.00,
  "created_at": "2026-01-01T10:30:45.123456Z",
  "created_by": 1,
  "creator": {
    "id": 1,
    "full_name": "John Doe",
    "email": "john@example.com"
  },
  "related_account_name": "Cash In Hand", // For group accounts
  "related_account_number": "1110" // For group accounts
}
```

### Required Fields

- ✅ `id`: Transaction ID
- ✅ `date`: Transaction date
- ✅ `voucher_type`: Type of voucher
- ✅ `reference_number`: Reference number (nullable)
- ✅ `description`: Description (nullable)
- ✅ `debit`: Debit amount
- ✅ `credit`: Credit amount
- ✅ `balance`: Running balance (mandatory)
- ✅ `created_at`: Exact timestamp (mandatory, ISO 8601)
- ✅ `created_by`: User ID who created the transaction
- ✅ `creator`: User object with `id`, `full_name`, and optionally `email`
- ✅ `related_account_name`: For group accounts, the child account name
- ✅ `related_account_number`: For group accounts, the child account number

## PDF Generation

### Recommended Libraries

- **Laravel**: Use `barryvdh/laravel-dompdf` or `spatie/laravel-pdf`
- **Alternative**: Use `mpdf/mpdf` or `tecnickcom/tcpdf`

### PDF Specifications

- **Page Size**: A4 (210mm × 297mm)
- **Orientation**: Portrait
- **Margins**: 15mm on all sides
- **Font**: Arial or similar sans-serif font
- **Font Sizes**:
  - Header: 16-18pt
  - Section titles: 12-14pt
  - Table headers: 10-11pt
  - Table content: 9-10pt
  - Footer: 8pt

### Styling Requirements

- **Header**: Bold, larger font, company branding
- **Table**: Clear borders, alternating row colors for readability
- **Totals Row**: Bold, highlighted background
- **Currency**: Right-aligned, formatted with 2 decimal places
- **Dates/Times**: Left or center-aligned, readable format

## Implementation Example (Laravel)

```php
// In AccountController
public function downloadStatement($id, Request $request)
{
    $account = Account::findOrFail($id);
    
    // Get transactions with filters
    $transactions = $this->accountService->getTransactionsForStatement(
        $account,
        $request->only(['start_date', 'end_date'])
    );
    
    // Load creator information for each transaction
    $transactions->load(['creator:id,full_name,email']);
    
    // Generate PDF
    $pdf = PDF::loadView('accounting.statement', [
        'account' => $account,
        'transactions' => $transactions,
        'startDate' => $request->start_date,
        'endDate' => $request->end_date,
        'generatedAt' => now(),
        'generatedBy' => auth()->user(),
    ]);
    
    $filename = sprintf(
        'account-statement-%s-%s.pdf',
        str_replace(' ', '-', strtolower($account->name)),
        $account->number ?? $account->id
    );
    
    return $pdf->download($filename);
}
```

## Error Handling

### Account Not Found (404)

```json
{
  "message": "Account not found."
}
```

### Unauthorized (403)

```json
{
  "message": "You do not have permission to view this account."
}
```

### Invalid Date Format (422)

```json
{
  "message": "The given data was invalid.",
  "errors": {
    "start_date": ["The start date must be a valid date in YYYY-MM-DD format."],
    "end_date": ["The end date must be a valid date in YYYY-MM-DD format."]
  }
}
```

## Performance Considerations

1. **Large Datasets**: For accounts with thousands of transactions:
   - Consider pagination in PDF (multiple pages)
   - Use efficient queries
   - Use database indexes on `date`, `account_id`, `created_at`
   - Consider background job for very large statements

2. **Caching**: Consider caching statement generation for frequently accessed accounts (with appropriate cache invalidation)

3. **Streaming**: For very large PDFs, consider streaming the response instead of generating the entire PDF in memory

## Testing Requirements

The backend should include tests for:

1. ✅ PDF is generated successfully for ledger accounts
2. ✅ PDF is generated successfully for group accounts
3. ✅ All transactions are included (no pagination limit)
4. ✅ Date filters work correctly
5. ✅ Creator information is included
6. ✅ Running balances are calculated correctly
7. ✅ Totals are calculated correctly (excluding net-zero transactions)
8. ✅ PDF format is correct (A4, readable, properly formatted)
9. ✅ Error handling works for invalid account IDs
10. ✅ Error handling works for unauthorized access

## Related Documents

- `docs/ACCOUNT-TRANSACTIONS-TIMESTAMP-BALANCE-BACKEND-REQUIREMENTS.md` - Transaction data requirements
- `docs/ACCOUNT-TRANSACTIONS-TOTALS-BACKEND-REQUIREMENTS.md` - Totals calculation requirements
- `docs/chart-of-accounts-backend.mdc` - Account structure

