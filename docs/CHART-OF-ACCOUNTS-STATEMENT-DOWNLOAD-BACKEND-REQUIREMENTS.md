# Chart of Accounts E-Statement Download - Backend Requirements

## Overview

This document specifies the backend requirements for generating and downloading a comprehensive e-statement (PDF) for the entire Chart of Accounts. This statement should include all accounts in the chart of accounts with their current balances, organized in a hierarchical tree structure.

## Status: ✅ IMPLEMENTED

**Backend Implementation Date**: [Implementation Date]

The Chart of Accounts E-Statement download feature has been fully implemented on the backend and integrated with the frontend.

### Implementation Summary

1. **Extended ChartOfAccountsService**: Added `getAccountsTree()` method with filters for `root_type`, `include_disabled`, `as_of_date`, and `include_balances`
2. **Added Controller Method**: `downloadChartOfAccountsStatement()` in `AccountController` with full validation and PDF generation
3. **Added Route**: `GET /api/accounts/statement` with proper authentication and permissions
4. **Frontend Integration**: Added `downloadChartOfAccountsStatement()` method to `accountsApi` and download button to Chart of Accounts page

## Problem Statement

The frontend currently has functionality to download e-statements for individual accounts (`GET /api/accounts/{id}/statement`), but there is no API endpoint to download a comprehensive statement for the entire chart of accounts. Users need the ability to download a complete chart of accounts report showing all accounts with their balances.

**✅ RESOLVED**: The API endpoint has been implemented and is now available.

## API Endpoint

**Endpoint**: `GET /api/accounts/statement` or `GET /api/chart-of-accounts/statement`

**Auth**: `auth:sanctum`, `module:module.accounting,read`

## Query Parameters

- `company_id` (required, integer): Company ID to generate the statement for
- `include_balances` (optional, boolean, default: `true`): Whether to include account balances in the statement
- `as_of_date` (optional, string, format: `YYYY-MM-DD`): Date to calculate balances as of (defaults to current date if not provided)
- `root_type` (optional, string): Filter by root type (`asset`, `liability`, `equity`, `income`, `expense`). If not provided, include all root types.
- `include_disabled` (optional, boolean, default: `false`): Whether to include disabled accounts in the statement

## Response

**Content-Type**: `application/pdf`

**Response**: PDF file (binary)

## E-Statement Content Requirements

### 1. Header Section

The PDF should include:

- **Company Information**:
  - Company name
  - Company address (if available)
  - Company logo (if available)
  
- **Report Title**: "Chart of Accounts Statement" or "Chart of Accounts E-Statement"
  
- **Report Period**:
  - "As of Date: [Date]" (or "Current Date" if no `as_of_date` provided)
  - Generated date and time
  - Generated by: [User Name]

### 2. Account Structure Display

The statement should display all accounts in a hierarchical tree structure, similar to the frontend's tree view. The structure should be organized by:

1. **Root Type** (Asset, Liability, Equity, Income, Expense)
2. **Parent-Child Relationships** (Group accounts and their children)
3. **Account Number** (if available, for sorting within groups)

#### For Each Account, Display:

| Column | Description | Format |
|--------|-------------|--------|
| **Account Number** | Account number (if available) | Text or "—" |
| **Account Name** | Full account name | Text |
| **Type** | Group or Ledger | Text |
| **Root Type** | Asset, Liability, Equity, Income, Expense | Text |
| **Normal Balance** | Debit or Credit (for ledger accounts) | Text |
| **Balance** | Current balance | Currency format (PKR 1,000.00) |
| **Status** | Enabled or Disabled | Text |

#### Tree Structure Indentation

- Use visual indentation to show parent-child relationships
- Group accounts should be clearly distinguished from ledger accounts
- Consider using icons or formatting (bold, different background) for group accounts

### 3. Summary Section

At the end of the statement, include summary totals by root type:

#### Summary by Root Type

| Root Type | Total Balance |
|-----------|--------------|
| Assets | PKR X,XXX.XX |
| Liabilities | PKR X,XXX.XX |
| Equity | PKR X,XXX.XX |
| Income | PKR X,XXX.XX |
| Expenses | PKR X,XXX.XX |
| **Grand Total** | **PKR X,XXX.XX** |

**Note**: The grand total should be the sum of all root types. For proper accounting, this may not balance to zero (assets + expenses vs liabilities + equity + income), but it should show the total of all balances.

#### Additional Summary Statistics

- **Total Accounts**: Count of all accounts (groups + ledgers)
- **Total Group Accounts**: Count of group accounts
- **Total Ledger Accounts**: Count of ledger accounts
- **Accounts with Zero Balance**: Count of accounts with balance = 0
- **Accounts with Non-Zero Balance**: Count of accounts with balance ≠ 0

### 4. Footer Section

- Page numbers (e.g., "Page 1 of 5")
- "Generated on: [Date] [Time]"
- "Generated by: [User Name]"
- "Company: [Company Name]"

## Data Requirements

### Account Data Structure

Each account in the response should include:

```json
{
  "id": 1,
  "company_id": 1,
  "name": "Cash In Hand",
  "number": "1110",
  "root_type": "asset",
  "is_group": false,
  "normal_balance": "debit",
  "balance": 15000.50,
  "is_disabled": false,
  "parent_id": 5,
  "parent": {
    "id": 5,
    "name": "Current Assets",
    "number": "1100"
  },
  "children": [] // Empty for ledger accounts, populated for group accounts
}
```

### Required Fields

- ✅ `id`: Account ID
- ✅ `company_id`: Company ID
- ✅ `name`: Account name
- ✅ `number`: Account number (nullable)
- ✅ `root_type`: Root type (asset, liability, equity, income, expense)
- ✅ `is_group`: Whether account is a group (boolean)
- ✅ `normal_balance`: Normal balance direction (debit/credit, nullable for groups)
- ✅ `balance`: Current balance (number, required when `include_balances=true`)
- ✅ `is_disabled`: Whether account is disabled (boolean)
- ✅ `parent_id`: Parent account ID (nullable)
- ✅ `parent`: Parent account object (nullable, with `id`, `name`, `number`)
- ✅ `children`: Array of child accounts (empty for ledger accounts)

### Balance Calculation

- **Ledger Accounts** (`is_group = false`): Return the individual account balance as of the specified date
- **Group Accounts** (`is_group = true`): Return the cumulative balance of all descendant ledger accounts
- Balances should respect the `as_of_date` parameter (calculate balances as of that date)
- If `include_balances=false`, set all balances to `null` or omit the balance column

### Tree Structure

The accounts should be returned in a hierarchical tree structure:

1. **Root Level**: Accounts with no parent (`parent_id = null`)
2. **Nested Levels**: Child accounts nested under their parent accounts
3. **Sorting**:
   - Within each level, sort by:
     1. Account number (if available, ascending)
     2. Account name (alphabetical, ascending)
   - Root types should be grouped together (all Assets, then all Liabilities, etc.)

## PDF Generation

### Recommended Libraries

- **Laravel**: Use `barryvdh/laravel-dompdf` or `spatie/laravel-pdf`
- **Alternative**: Use `mpdf/mpdf` or `tecnickcom/tcpdf`

### PDF Specifications

- **Page Size**: A4 (210mm × 297mm)
- **Orientation**: Portrait
- **Margins**: 15mm on all sides
- **Font**: Arial or similar sans-serif font
- **Font Sizes**:
  - Header: 16-18pt
  - Section titles: 12-14pt
  - Table headers: 10-11pt
  - Table content: 9-10pt
  - Footer: 8pt

### Styling Requirements

- **Header**: Bold, larger font, company branding
- **Tree Structure**: 
  - Use indentation (e.g., 20px per level) to show hierarchy
  - Group accounts: Bold text, possibly different background color
  - Ledger accounts: Regular text
- **Table**: Clear borders, alternating row colors for readability
- **Summary Section**: Bold, highlighted background
- **Currency**: Right-aligned, formatted with 2 decimal places
- **Account Numbers**: Left-aligned or center-aligned
- **Account Names**: Left-aligned with appropriate indentation

### Page Breaks

- Avoid breaking parent-child relationships across pages
- If a group account and its children span multiple pages, repeat the group account header on the new page
- Keep summary section on the last page

## Implementation Example (Laravel)

```php
// In AccountController or ChartOfAccountsController
public function downloadChartOfAccountsStatement(Request $request)
{
    $companyId = $request->input('company_id');
    $includeBalances = $request->boolean('include_balances', true);
    $asOfDate = $request->input('as_of_date', now()->format('Y-m-d'));
    $rootType = $request->input('root_type');
    $includeDisabled = $request->boolean('include_disabled', false);
    
    // Validate company_id
    if (!$companyId) {
        return response()->json([
            'message' => 'Company ID is required.'
        ], 422);
    }
    
    // Get accounts tree with balances
    $accounts = $this->accountService->getAccountsTree(
        $companyId,
        [
            'include_balances' => $includeBalances,
            'as_of_date' => $asOfDate,
            'root_type' => $rootType,
            'include_disabled' => $includeDisabled,
        ]
    );
    
    // Calculate summary statistics
    $summary = $this->calculateSummary($accounts);
    
    // Generate PDF
    $pdf = PDF::loadView('accounting.chart-of-accounts-statement', [
        'accounts' => $accounts,
        'summary' => $summary,
        'asOfDate' => $asOfDate,
        'includeBalances' => $includeBalances,
        'generatedAt' => now(),
        'generatedBy' => auth()->user(),
        'company' => auth()->user()->company, // Or fetch company by ID
    ]);
    
    $filename = sprintf(
        'chart-of-accounts-statement-%s-%s.pdf',
        $companyId,
        now()->format('Y-m-d')
    );
    
    return $pdf->download($filename);
}

private function calculateSummary($accounts)
{
    $summary = [
        'assets' => 0,
        'liabilities' => 0,
        'equity' => 0,
        'income' => 0,
        'expenses' => 0,
        'total_accounts' => 0,
        'total_groups' => 0,
        'total_ledgers' => 0,
        'zero_balance_count' => 0,
        'non_zero_balance_count' => 0,
    ];
    
    $this->traverseAccounts($accounts, function($account) use (&$summary) {
        $summary['total_accounts']++;
        
        if ($account->is_group) {
            $summary['total_groups']++;
        } else {
            $summary['total_ledgers']++;
        }
        
        if ($account->balance !== null) {
            $rootType = $account->root_type;
            if (isset($summary[$rootType])) {
                $summary[$rootType] += $account->balance;
            }
            
            if ($account->balance == 0) {
                $summary['zero_balance_count']++;
            } else {
                $summary['non_zero_balance_count']++;
            }
        }
    });
    
    $summary['grand_total'] = array_sum([
        $summary['assets'],
        $summary['liabilities'],
        $summary['equity'],
        $summary['income'],
        $summary['expenses'],
    ]);
    
    return $summary;
}

private function traverseAccounts($accounts, $callback)
{
    foreach ($accounts as $account) {
        $callback($account);
        if (!empty($account->children)) {
            $this->traverseAccounts($account->children, $callback);
        }
    }
}
```

## Error Handling

### Missing Company ID (422)

```json
{
  "message": "The given data was invalid.",
  "errors": {
    "company_id": ["The company id field is required."]
  }
}
```

### Company Not Found (404)

```json
{
  "message": "Company not found."
}
```

### Unauthorized (403)

```json
{
  "message": "You do not have permission to view the chart of accounts."
}
```

### Invalid Date Format (422)

```json
{
  "message": "The given data was invalid.",
  "errors": {
    "as_of_date": ["The as of date must be a valid date in YYYY-MM-DD format."]
  }
}
```

### Invalid Root Type (422)

```json
{
  "message": "The given data was invalid.",
  "errors": {
    "root_type": ["The root type must be one of: asset, liability, equity, income, expense."]
  }
}
```

## Performance Considerations

1. **Large Chart of Accounts**: For companies with hundreds or thousands of accounts:
   - Use efficient database queries with proper indexes
   - Consider using recursive CTEs or closure tables for tree traversal
   - Cache account tree structure if it doesn't change frequently
   - Use eager loading to avoid N+1 queries

2. **Balance Calculation**: 
   - For large datasets, consider calculating balances in batches
   - Use database aggregation functions where possible
   - Consider caching balances if they don't need to be real-time

3. **PDF Generation**:
   - For very large charts of accounts, consider pagination
   - Use streaming PDF generation for large files
   - Consider background job processing for very large statements

4. **Memory Management**:
   - Process accounts in chunks if memory is a concern
   - Use generators where possible to avoid loading all data into memory at once

## Testing Requirements

The backend should include tests for:

1. ✅ PDF is generated successfully for a company with accounts
2. ✅ All accounts are included in the correct hierarchical structure
3. ✅ Balances are calculated correctly for ledger accounts
4. ✅ Balances are calculated correctly for group accounts (cumulative)
5. ✅ Tree structure is maintained correctly (parent-child relationships)
6. ✅ Summary statistics are calculated correctly
7. ✅ Date filtering works (`as_of_date` parameter)
8. ✅ Root type filtering works (`root_type` parameter)
9. ✅ Disabled accounts are excluded when `include_disabled=false`
10. ✅ Disabled accounts are included when `include_disabled=true`
11. ✅ Error handling works for missing company ID
12. ✅ Error handling works for invalid company ID
13. ✅ Error handling works for unauthorized access
14. ✅ Error handling works for invalid date format
15. ✅ PDF format is correct (A4, readable, properly formatted)
16. ✅ Page breaks don't break parent-child relationships

## Frontend Integration

✅ **IMPLEMENTED**: The frontend integration has been completed.

### API Client Method

The `downloadChartOfAccountsStatement()` method has been added to `app/lib/apiClient.ts`:

```typescript
// In app/lib/apiClient.ts
async downloadChartOfAccountsStatement(
  companyId: number, 
  params?: { 
    include_balances?: boolean;
    as_of_date?: string;
    root_type?: string;
    include_disabled?: boolean;
  }
): Promise<Blob> {
  const token = typeof window !== "undefined" ? localStorage.getItem("access_token") : null;
  const query = new URLSearchParams();
  query.set("company_id", companyId.toString());
  if (params?.include_balances !== undefined) query.set("include_balances", params.include_balances.toString());
  if (params?.as_of_date) query.set("as_of_date", params.as_of_date);
  if (params?.root_type) query.set("root_type", params.root_type);
  if (params?.include_disabled !== undefined) query.set("include_disabled", params.include_disabled.toString());
  
  const path = `/accounts/statement?${query.toString()}`;
  const headers: HeadersInit = {
    Accept: "application/pdf",
  };
  if (token) {
    headers.Authorization = `Bearer ${token}`;
  }
  
  const response = await fetch(`${API_BASE_URL}${path}`, {
    method: "GET",
    credentials: "include",
    headers,
  });
  
  if (!response.ok) {
    const errorData = await response.json().catch(() => ({ message: "Failed to download chart of accounts statement" }));
    throw new ApiError(errorData.message || "Failed to download chart of accounts statement", response.status, errorData);
  }
  
  return await response.blob();
}
```

### UI Integration

A "Download E-Statement" button has been added to the Chart of Accounts page (`app/chart-of-accounts/page.tsx`):

- Button is visible to users with `module.accounting` read permissions
- Located in the header section next to the view mode toggle
- Downloads PDF with filename: `chart-of-accounts-statement-YYYY-MM-DD.pdf`
- Shows success/error toast notifications

## Related Documents

- `docs/ACCOUNT-STATEMENT-DOWNLOAD-BACKEND-REQUIREMENTS.md` - Individual account statement requirements
- `docs/chart-of-accounts-backend.mdc` - Chart of Accounts API specification
- `docs/chart-of-accounts-new-features.md` - Balance display and account deletion features
- `docs/ACCOUNT-TRANSACTIONS-TIMESTAMP-BALANCE-BACKEND-REQUIREMENTS.md` - Transaction data requirements

## Notes

- This endpoint should reuse the same account tree structure logic as `GET /api/accounts/tree`
- The balance calculation should be consistent with the balance display in the frontend
- Consider adding caching for frequently accessed chart of accounts statements
- The statement should be suitable for printing and archival purposes

